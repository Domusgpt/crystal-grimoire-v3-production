<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="üîÆ CrystalGrimoire - AI Crystal Identification & Spiritual Guidance">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="CrystalGrimoire">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&family=Noto+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <title>üîÆ CrystalGrimoire - Crystal Identification</title>
  <link rel="manifest" href="manifest.json">

  <!-- SIMPLIFIED Firebase SDK - Only Essential Modules -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

</head>
<body>
  <script>
    // Clear any existing auth state to prevent conflicts
    if (typeof localStorage !== 'undefined') {
      // Clear vestigial auth data
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('firebase') || key.includes('auth') || key.includes('user'))) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      console.log('üßπ Cleared vestigial auth data:', keysToRemove.length, 'items');
    }

    // Initialize Firebase with clean state
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCfaw8I-rwXu8j0El340yIGr-N2agTzp6c",
        authDomain: "crystalgrimoire-production.firebaseapp.com",
        projectId: "crystalgrimoire-production",
        storageBucket: "crystalgrimoire-production.firebasestorage.app",
        messagingSenderId: "937741022651",
        appId: "1:937741022651:web:cf181d053f178c9298c09e"
      };

      // Initialize Firebase
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
        console.log('üî• Firebase initialized cleanly');
        
        // Set up clean auth state listener
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            console.log('‚úÖ User authenticated:', user.email);
            // Update profile with real data
            setTimeout(() => {
              const nameInputs = document.querySelectorAll('input[placeholder*="name"], input[value*="Spiritual Seeker"]');
              const emailInputs = document.querySelectorAll('input[placeholder*="email"], input[value*="user@example.com"]');
              
              nameInputs.forEach(input => {
                input.value = user.displayName || 'Paul Phillips';
                input.dispatchEvent(new Event('input', { bubbles: true }));
              });
              
              emailInputs.forEach(input => {
                input.value = user.email || 'phillips.paul.email@gmail.com';
                input.dispatchEvent(new Event('input', { bubbles: true }));
              });
              
              console.log('üìù Profile updated with real user data');
            }, 1000);
          } else {
            console.log('‚ùå No user authenticated');
          }
        });
      }
    });

    // Simplified service worker configuration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('/flutter_service_worker.js', {
          scope: '/'
        }).catch(function(error) {
          console.log('Service Worker registration ignored:', error);
        });
      });
    }
    
    window.flutterConfiguration = {
      serviceWorkerSettings: {
        serviceWorkerVersion: null,
        timeoutMillis: 2000,
      }
    };
  </script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>